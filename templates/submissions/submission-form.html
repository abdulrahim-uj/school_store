{% extends 'base.html' %}
{% block content %}
    <div class="container">
        <div class="container py-5">
            <h1>Order</h1>
        </div>
        <form class="row g-3" method="POST" action="{{ url }}">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-6">
                    <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }}</label>
                    {{ form.name }}
                </div>
                <div class="col-md-6">
                    <label for="{{ form.dob.id_for_label }}" class="form-label">{{ form.dob.label }}</label>
                    {{ form.dob }}
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <label for="{{ form.age.id_for_label }}" class="form-label">{{ form.age.label }}</label>
                    {{ form.age }}
                </div>
                <div class="col-md-6">
                    <label for="{{ form.gender.id_for_label }}" class="form-check-label">{{ form.gender.label }}</label>
                    {{ form.gender }}
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <label for="{{ form.phone.id_for_label }}" class="form-label">{{ form.phone.label }}</label>
                    {{ form.phone }}
                </div>
                <div class="col-md-6">
                    <label for="{{ form.email.id_for_label }}" class="form-label">{{ form.email.label }}</label>
                    {{ form.email }}
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <label for="{{ form.address.id_for_label }}" class="form-label">{{ form.address.label }}</label>
                    {{ form.address }}
                </div>
                <div class="col-md-6">
                    <label for="{{ form.department.id_for_label }}"
                           class="form-label">{{ form.department.label }}</label>
                    {{ form.department }}
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <label for="{{ form.course.id_for_label }}" class="form-label">{{ form.course.label }}</label>
                    {{ form.course }}
                </div>
                <div class="col-md-6">
                    <label for="{{ form.purpose.id_for_label }}" class="form-label">{{ form.purpose.label }}</label>
                    {{ form.purpose }}
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="form-check">
                        {{ form.materials }}
                        <label for="{{ form.materials.id_for_label }}"
                               class="form-check-label">{{ form.materials.label }}</label>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">Submit & Logout</button>
                </div>
            </div>
        </form>
    </div>

    <script type="text/javascript">
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        let csrf_token = '{{ csrf_token }}';


        let department_field = document.getElementById("id_department");  // get the state_field
        department_field.addEventListener("change", getDepartmentId);

        function getDepartmentId(e) {
            let department = e.target.value;  // assign the id of the state to state_id
            console.log(e.target.value);

            const data = {'id': department};  // the data we are passing to the backend
            let url = "{% url 'submissions:getCourse' %}";  // the url we are posting the state id to on the backend

            fetch(url, {
                method: 'POST', // or 'PUT'\
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf_token
                },
                body: JSON.stringify(data),
            })
                .then((response) => response.json())
                .then((data) => {
                    console.log('Success:', data);
                    let course_field = document.getElementById("id_course");  // get the ID of town field
                    course_field.innerHTML = '<option value="" selected}>Select Course</option>'  // add to its innerhtml
                      for (let i=0; i < data.length; i++ ) {
                          /* loop across the data gotten from the backend */
                          course_field.innerHTML += `<option value="${data[i]['id']}">${data[i]['course_name']}</option>`
                          // console.log(${data[i]['name']});
                      }
                })
                .catch((error) => {
                    console.error('Error:', error);
                    alert("Error");
                });
        }

        let date_of_birth = document.getElementById("id_dob");
        date_of_birth.addEventListener("change", ageCalc);
        function ageCalc() {
            let date_of_birth = document.getElementById("id_dob").value;
            var today = new Date();
            var birthDate = new Date(date_of_birth);
            var age = today.getFullYear() - birthDate.getFullYear();
            document.getElementById("id_age").value = age;
        }
    </script>
{% endblock %}

